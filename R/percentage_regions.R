#' Plot the percentage of P-sites per transcript region.
#' 
#' For one or several samples this function computes the percentage of P-sites
#' falling in the three annotated regions of the transcripts (5' UTR, CDS and
#' 3'UTR) and generates a barplot of the resulting values. The function also
#' calculates and plots the percentage of region length for the selected
#' transcripts (reported in column "RNAs").
#' 
#' @param data A list of data tables from \code{\link{psite_info}}.
#' @param annotation A data table as generated by
#'   \code{\link{create_annotation}}.
#' @param sample A character string vector specifying the name of the sample(s)
#'   of interest. By default this argument is NULL, meaning that all the samples
#'   in \code{data} are included in the analysis.
#' @param transcripts A character string vector specifying the name of the
#'   transcripts to be included in the analysis. By default this argument is
#'   NULL, meaning that all the transcripts in \code{data} are used. Please note
#'   that the transcripts not associated to any annotated \emph{5' UTR},
#'   \emph{CDS} and \emph{3'UTR} are automatically discarded.
#' @param label A character string vector of the same length of \code{sample}
#'   specifying the name of the samples to be displaied in the plot. By default
#'   this argument is NULL meaning that the name of the samples are used.
#' @param colour A character string vector of three elements specifying the
#'   colours of the bars corresponding to the \emph{5' UTR}, the \emph{CDS} and
#'   the \emph{3'UTR} respectively. The default is a grayscale.
#' @return A list containing a ggplot2 object, and a data table with the
#'   associated data.
#' @examples
#' data(reads_psite_list)
#' data(mm81cdna)
#'
#' reg_psite <- region_psite(reads_psite_list, mm81cdna, sample = "Samp1")
#' reg_psite[["plot"]]
#' @import data.table
#' @import ggplot2
#' @export
region_psite <- function(data, annotation, sample = NULL, transcripts = NULL,
                         label = NULL, colour = c("gray70", "gray40", "gray10")) {

  l_transcripts <- as.character(annotation[l_utr5 > 0 & 
                                             l_cds > 0 &
                                             l_cds %% 3 == 0 &
                                             l_utr3 > 0, transcript])

  if (length(transcripts) == 0) {
    c_transcript <- l_transcripts
  } else {
    c_transcript <- intersect(l_transcripts, transcripts)
  }
  
  if(length(sample) == 0) {
    sample <- names(data)
  }
  
  if(length(label) == 0) {
    label <- sample
  }
  
  for(sam in sample) {
    frame_dt <- data[[sam]][as.character(transcript) %in% c_transcript
                            ][, list(percentage = .N), by = list(region = psite_region)
                              ][, sample := sam
                                ][, percentage := (percentage / sum(percentage)) * 100]
    
    if (exists("melt_table")) {
      melt_table <- rbind(melt_table, frame_dt)
    } else {
      melt_table <- frame_dt
    }
    
  }
  
  melt_table[, class := "mapped"
             ][, sample := factor(sample, levels = unique(sample), labels = label)]

  sub_anno <- annotation[as.character(transcript) %in% c_transcript]
  RNA_reg <- colSums(sub_anno[, list(l_utr5, l_cds, l_utr3)])
  RNA_reg_perc <- (RNA_reg / sum(RNA_reg)) * 100
  
  RNA_table <- data.table(region = c("5utr", "cds", "3utr"),
                          percentage = RNA_reg_perc,
                          sample = rep("RNAs", 3),
                          class = "rna")
  
  final_melt_table <- rbind(melt_table, RNA_table)
  final_melt_table <- final_melt_table[, region := factor(region,
                                                          levels = c("5utr", "cds", "3utr"),
                                                          labels = c("5' UTR  ","CDS  ","3' UTR"))
                   ][order(region)]
  
  bs <- 25
  bp <- ggplot(final_melt_table,aes(x = sample, y = percentage, fill = region)) +
    geom_bar(stat = "identity",color = "white",width = 0.65, alpha = 0.9, size = 0.025 * bs) +
    scale_fill_manual(name = "", values = colour) +
    theme_bw(base_size = bs) +
    theme(legend.position = "top", legend.key = element_blank()) +
    theme(axis.title.x = element_blank()) +
    scale_x_discrete(breaks = unique(final_melt_table$sample)) +
    facet_grid( . ~ class, scales = "free", space="free_x") +
    theme(strip.background = element_blank(), strip.text = element_blank()) +
    scale_y_continuous("P-sites (%)", sec.axis = sec_axis(~ . * 1 , name = "Length (%)"))
  
  output <- list()
  output[["plot"]] <- bp
  output[["dt"]] <- final_melt_table
  return(output)
}

















